# AI 聊天模式说明

## 自动适配机制

前端发送 `think: true` 请求后，**根据后端实际返回的数据自动判断模式**：

### 情况1：后端支持思考模式
**后端返回：**
- `reasoningContent`（思考过程）
- `content`（最终答案）

**前端行为：**
- 先显示思考过程（流式）
- 再显示最终答案（流式）
- 显示"思考完成(用时X秒)"

### 情况2：后端不支持思考模式
**后端返回：**
- 只有 `content`（直接答案）
- 没有 `reasoningContent`

**前端行为：**
- 自动切换到直接回复模式
- 直接流式显示答案
- 不显示思考过程区域

## 核心逻辑

```dart
// 自动检测标志
bool backendSupportsThinking = false;
bool hasReceivedContent = false;

onMessage: (data) {
  // 检测后端是否支持思考模式
  if (data.reasoningContent != null && data.reasoningContent!.isNotEmpty) {
    backendSupportsThinking = true; // 收到思考内容，后端支持
    thinkingContent += data.reasoningContent!;
  }

  // 累积回复内容
  if (data.content != null && data.content!.isNotEmpty) {
    hasReceivedContent = true;
    replyContent += data.content!;
  }

  // 自动判断实际模式
  final actualMode = backendSupportsThinking ? '思考模式' : '直接回复模式';
  
  // 创建消息（两种模式都兼容）
  final aiMessage = UiMessage(
    text: replyContent, // 可能为空（思考阶段）或有内容（直接回复）
    thinkingProcess: thinkingContent.isNotEmpty ? thinkingContent : null,
    isThinkingDone: false,
  );
}
```

## UI 表现

### 后端支持思考模式
```
┌─────────────────────────────┐
│ 思考中... ⏳                │
│ ┌─────────────────────────┐ │
│ │ 思考内容流式显示...      │ │
│ └─────────────────────────┘ │
└─────────────────────────────┘
        ↓ 思考完成后
┌─────────────────────────────┐
│ 思考完成(用时3秒) ✅         │
│ ┌─────────────────────────┐ │
│ │ 完整的思考过程          │ │
│ └─────────────────────────┘ │
│                             │
│ 最终答案流式显示...         │
└─────────────────────────────┘
```

### 后端不支持思考模式
```
┌─────────────────────────────┐
│ 思考中... ⏳                │
└─────────────────────────────┘
        ↓ 收到内容后
┌─────────────────────────────┐
│ 答案内容流式显示...         │
│ 持续累积更新...             │
└─────────────────────────────┘
```

## 调试日志示例

### 后端支持思考模式
```
🎯 _sendMessageWithSSE 开始执行
📝 message: 分析这个问题, sessionId: 123
发送消息: 分析这个问题, 思考模式: true
📨 收到 SSE 事件 - eventType: message
✅ 收到思考内容: 首先我需要...
📊 累积思考内容: 首先我需要...
🧠 思考内容更新: 15 字符
🔄 更新消息 [思考模式] - 思考: 15 字符, 回复: 0 字符
✅ 收到回复内容: 答案是...
📊 累积回复内容: 答案是...
💬 文本内容更新: 6 字符
🔄 更新消息 [思考模式] - 思考: 15 字符, 回复: 6 字符
✅ 消息接收完成 [思考模式]
📊 最终思考过程: 首先我需要... (15 字符)
📊 最终回复内容: 答案是... (6 字符)
⏱️ 用时: 3 秒
🎯 最终消息已更新 [思考模式]
```

### 后端不支持思考模式（自动降级）
```
🎯 _sendMessageWithSSE 开始执行
📝 message: 你好, sessionId: 123
发送消息: 你好, 思考模式: true
📨 收到 SSE 事件 - eventType: message
✅ 收到回复内容: 你好！我是AI助手
📊 累积回复内容: 你好！我是AI助手
💬 文本内容更新: 12 字符
🔄 更新消息 [直接回复模式] - 思考: 0 字符, 回复: 12 字符
✅ 消息接收完成 [直接回复模式]
📊 最终思考过程:  (0 字符)
📊 最终回复内容: 你好！我是AI助手 (12 字符)
⏱️ 用时: 1 秒
🎯 最终消息已更新 [直接回复模式]
```

## 优势

1. **无需手动配置**：前端不需要知道后端是否支持思考模式
2. **自动降级**：后端不支持时自动切换到直接回复模式
3. **统一代码**：一套代码兼容两种情况
4. **实时检测**：根据实际收到的数据动态判断
5. **用户体验一致**：无论哪种模式，都能正常显示内容
